<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="运维笔记"><title>Linux虚拟网络基础 | 哦吼吼吼</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/latest/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/pure-min.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/latest/grids-responsive-min.min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/latest/jquery.min.js"></script><link rel="icon" mask="" sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><script type="text/javascript" src="//lib.baomitu.com/clipboard.js/latest/clipboard.min.js"></script><script type="text/javascript" src="//lib.baomitu.com/toastr.js/latest/toastr.min.js"></script><link rel="stylesheet" href="//lib.baomitu.com/toastr.js/latest/toastr.min.css"><meta name="generator" content="Hexo 6.3.0"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Linux虚拟网络基础</h1><a id="logo" href="/.">哦吼吼吼</a><p class="description">运维笔记</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Linux虚拟网络基础</h1><div class="post-meta">2022-10-12</div><div class="post-content"><h2 id="Router"><a href="#Router" class="headerlink" title="Router"></a>Router</h2><p>router在虚拟网络中就是路由器，实现三层通信作用。</p>
<p>Linux 本身开启转发功能后就是一个路由器。</p>
<h3 id="临时启用"><a href="#临时启用" class="headerlink" title="临时启用"></a>临时启用</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;1&quot; &gt; /proc/sys/net/ipv4/ip_forward</span><br></pre></td></tr></table></figure>

<h3 id="永久启用"><a href="#永久启用" class="headerlink" title="永久启用"></a>永久启用</h3><p>修改 &#x2F;etc&#x2F;sysctl.conf ，将net.ipv4.ip_forward&#x3D;0修改为1</p>
<h2 id="veth-pair"><a href="#veth-pair" class="headerlink" title="veth pair"></a>veth pair</h2><p>veth pair是成对出现的一种虚拟网络设备接口，一端连着网络协议栈，一端彼此相连。</p>
<p>由于它的这个特性，常常被用于构建虚拟网络拓扑。例如连接两个不同的网络命名空间(netns)，连接docker容器，连接网桥(Bridge)等，其中一个很常见的案例就是OpenStack Neutron底层用它来构建非常复杂的网络拓扑。</p>
<h3 id="直接相连"><a href="#直接相连" class="headerlink" title="直接相连"></a>直接相连</h3><p>一对 veth-pair 直接将两个 namespace 连接在一起。</p>
<h3 id="通过Bridge相连"><a href="#通过Bridge相连" class="headerlink" title="通过Bridge相连"></a>通过Bridge相连</h3><p>Linux Bridge 相当于一台交换机，可以中转两个 namespace 的流量。</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>直接相连的方式连接连个命名空间，veth pair配置完成后，直接ping对方的IP地址</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"># 创建veth pair</span><br><span class="line">ip link add tap1 type veth peer name tap2</span><br><span class="line"># 创建namespace </span><br><span class="line">ip netns add ns1</span><br><span class="line">ip netns add ns2</span><br><span class="line"># 把两个tap分别迁移到对应的namespace中</span><br><span class="line">ip link set tap1 netns ns1</span><br><span class="line">ip link set tap2 netns ns2</span><br><span class="line"># 分别给两个tap绑定IP地址</span><br><span class="line">ip netns exec ns1 ip addr add local 192.168.50.1/24 dev tap1</span><br><span class="line">ip netns exec ns2 ip addr add local 192.168.50.2/24 dev tap2</span><br><span class="line"># 将两个tap设置为up</span><br><span class="line">ip netns exec ns1 ifconfig tap1 up</span><br><span class="line">ip netns exec ns2 ifconfig tap2 up</span><br><span class="line"># ping</span><br><span class="line">ip netns exec ns2 ping 192.168.50.1 </span><br><span class="line">ip netns exec ns1 ping 192.168.50.2</span><br><span class="line"># 查看路由</span><br><span class="line">ip netns exec ns1 route -n</span><br><span class="line">ip netns exec ns2 route -n</span><br><span class="line">#修改路由出口为veth</span><br><span class="line">ip netns exec ns1 ip route change 192.168.50.0/24 via 0.0.0.0 dev tap1</span><br><span class="line">ip netns exec ns2 ip route change 192.168.50.0/24 via 0.0.0.0 dev tap2</span><br></pre></td></tr></table></figure>

<h2 id="Linux-Bridge"><a href="#Linux-Bridge" class="headerlink" title="Linux Bridge"></a>Linux Bridge</h2><p>Linux Bridge（网桥）是用纯软件实现的虚拟交换机，有着和物理交换机相同的功能，例如二层交换，MAC地址学习等。因此我们可以把tun&#x2F;tap，veth pair等设备绑定到网桥上，就像是把设备连接到物理交换机上一样。此外它和veth pair、tun&#x2F;tap一样，也是一种虚拟网络设备，具有虚拟设备的所有特性，例如配置IP，MAC地址等。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y bridge-utils</span><br></pre></td></tr></table></figure>

<h3 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"># 添加网桥</span><br><span class="line">brctl addbr br0</span><br><span class="line"># 启动网桥</span><br><span class="line">ip link set br0 up</span><br><span class="line"></span><br><span class="line"># 新增三个netns</span><br><span class="line">ip netns add ns0</span><br><span class="line">ip netns add ns1</span><br><span class="line">ip netns add ns2</span><br><span class="line"></span><br><span class="line"># 新增两对veth</span><br><span class="line">ip link add veth0-ns type veth peer name veth0-br</span><br><span class="line">ip link add veth1-ns type veth peer name veth1-br</span><br><span class="line">ip link add veth2-ns type veth peer name veth2-br</span><br><span class="line"></span><br><span class="line"># 将veth的一端移动到netns中</span><br><span class="line">ip link set veth0-ns netns ns0</span><br><span class="line">ip link set veth1-ns netns ns1</span><br><span class="line">ip link set veth2-ns netns ns2</span><br><span class="line"></span><br><span class="line"># 将netns中的本地环回和veth启动并配置IP</span><br><span class="line">ip netns exec ns0 ip link set lo up</span><br><span class="line">ip netns exec ns0 ip link set veth0-ns up</span><br><span class="line">ip netns exec ns0 ip addr add 10.0.0.1/24 dev veth0-ns</span><br><span class="line"></span><br><span class="line">ip netns exec ns1 ip link set lo up</span><br><span class="line">ip netns exec ns1 ip link set veth1-ns up</span><br><span class="line">ip netns exec ns1 ip addr add 10.0.0.2/24 dev veth1-ns</span><br><span class="line"></span><br><span class="line">ip netns exec ns2 ip link set lo up</span><br><span class="line">ip netns exec ns2 ip link set veth2-ns up</span><br><span class="line">ip netns exec ns2 ip addr add 10.0.0.3/24 dev veth2-ns</span><br><span class="line"></span><br><span class="line"># 将veth的另一端启动并挂载到网桥上</span><br><span class="line">ip link set veth0-br up</span><br><span class="line">ip link set veth1-br up</span><br><span class="line">ip link set veth2-br up</span><br><span class="line">brctl addif br0 veth0-br</span><br><span class="line">brctl addif br0 veth1-br</span><br><span class="line">brctl addif br0 veth2-br</span><br></pre></td></tr></table></figure>

<h3 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip netns exec ns0 ping 10.0.0.2</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>一般linux会把bridge的fowrding禁用，所以还需要进行iptable的配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">iptables -A FORWARD -i bridgename -j ACCEPT</span><br></pre></td></tr></table></figure></div><div class="tags"></div><div class="post-nav"><a class="next" href="/2022/10/12/network-vxlan/">network_vxlan</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="http://example.com"/></form></div><div class="widget"><div class="author-info"><a class="info-avatar" href="/about/" title="关于"><img src="/img/avatar.png"/></a><p>To be a better man.</p><a class="info-icon" href="https://twitter.com/username" title="Twitter" target="_blank" style="margin-inline:5px"> <i class="fa fa-twitter-square" style="margin-inline:5px"></i></a><a class="info-icon" href="mailto:lixinyudddd@gmail.com" title="Email" target="_blank" style="margin-inline:5px"> <i class="fa fa-envelope-square" style="margin-inline:5px"></i></a><a class="info-icon" href="https://github.com/xigua0505" title="Github" target="_blank" style="margin-inline:5px"> <i class="fa fa-github-square" style="margin-inline:5px"></i></a><a class="info-icon" href="/atom.xml" title="RSS" target="_blank" style="margin-inline:5px"> <i class="fa fa-rss-square" style="margin-inline:5px"></i></a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2022/10/12/network/">Linux虚拟网络基础</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/12/network-vxlan/">network_vxlan</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/12/network-vlan/">network_vlan</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/11/ceph1/">近期能用到的命令</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/11/ceph/">Ceph学习笔记</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/10/kvm/">kvm</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/09/some-about-setup-py/">Detailed explanation of setup.py</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/09/local-ssl-cert/">如何实现局域网https访问</a></li><li class="post-list-item"><a class="post-list-link" href="/2022/10/09/hello-world/">Hello World</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="http://www.example1.com/" title="site-name1" target="_blank">site-name1</a><ul></ul><a href="http://www.example2.com/" title="site-name2" target="_blank">site-name2</a><ul></ul><a href="http://www.example3.com/" title="site-name3" target="_blank">site-name3</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2022 <a href="/." rel="nofollow">哦吼吼吼.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.js"></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0"></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/latest/jquery.fancybox.min.css"><script type="text/javascript" src="/js/copycode.js?v=1.0.0" successtext="复制成功!"></script><link rel="stylesheet" type="text/css" href="/css/copycode.css?v=1.0.0"><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>